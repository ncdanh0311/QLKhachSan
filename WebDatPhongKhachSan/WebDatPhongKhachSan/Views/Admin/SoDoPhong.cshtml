@model List<WebDatPhongKhachSan.Models.PhongStatusVM>
@{
    ViewBag.Title = "Sơ đồ phòng";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    DateTime targetDate = ViewBag.TargetDate;
}

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
        <div>
            <h3 class="fw-bold text-primary mb-0"><i class="fa-solid fa-hotel me-2"></i>Sơ đồ phòng</h3>
            <h5 class="text-secondary mt-1">@ViewBag.TenKS</h5>
            <span class="text-muted small">Dữ liệu ngày: <b>@targetDate.ToString("dd/MM/yyyy")</b></span>
        </div>

        <form method="get" class="d-flex gap-2">
            <input type="date" name="date" class="form-control" value="@targetDate.ToString("yyyy-MM-dd")" />
            <button class="btn btn-primary fw-bold"><i class="fa-solid fa-eye me-1"></i>Xem</button>
            <a href="@Url.Action("SoDoPhong")" class="btn btn-outline-secondary"><i class="fa-solid fa-rotate-left"></i></a>
        </form>
    </div>

    @if (TempData["Msg"] != null)
    {
        <div class="alert alert-success shadow-sm border-0"><i class="fa-solid fa-check-circle me-2"></i>@TempData["Msg"]</div>
    }
    @if (TempData["Err"] != null)
    {
        <div class="alert alert-danger shadow-sm border-0"><i class="fa-solid fa-triangle-exclamation me-2"></i>@TempData["Err"]</div>
    }

    <div class="row g-3">
        @foreach (var p in Model)
        {
            // --- XỬ LÝ MÀU SẮC DỰA TRÊN TRẠNG THÁI ---
            string borderClass = "border-success"; // Mặc định: Sẵn sàng (Xanh)
            string bgHeader = "bg-success bg-opacity-10 text-success";
            string icon = "fa-door-open";

            // Logic: Nếu phòng đang có khách hoặc trạng thái vật lý là đang có khách
            if (p.TrangThaiPhong == "Đang có khách" || p.CoKhach == "Có")
            {
                borderClass = "border-danger"; // Đỏ
                bgHeader = "bg-danger bg-opacity-10 text-danger";
                icon = "fa-user-lock";
            }
            else if (p.TrangThaiPhong == "Chờ dọn")
            {
                borderClass = "border-warning"; // Vàng
                bgHeader = "bg-warning bg-opacity-10 text-warning";
                icon = "fa-broom";
            }
            else if (p.TrangThaiPhong == "Bảo trì")
            {
                borderClass = "border-secondary"; // Xám
                bgHeader = "bg-secondary bg-opacity-10 text-secondary";
                icon = "fa-screwdriver-wrench";
            }

            <div class="col-6 col-md-4 col-lg-3">
                <div class="card h-100 shadow-sm @borderClass" style="border-width: 1px; border-radius: 12px; overflow:hidden;">
                    <div class="card-header @bgHeader fw-bold d-flex justify-content-between align-items-center border-0 py-2">
                        <span><i class="fa-solid @icon me-2"></i>P.@p.SoPhong</span>
                        <span class="badge bg-white text-dark border shadow-sm">Tầng @p.Tang</span>
                    </div>

                    <div class="card-body p-3">
                        <div class="small text-muted fw-bold mb-2">@p.LoaiPhong</div>

                        @if (p.CoKhach == "Có")
                        {
                            <div class="mb-1 text-truncate fw-bold text-primary" title="@p.TenKhach">
                                <i class="fa-solid fa-user me-1"></i>@p.TenKhach
                            </div>
                            <div class="small mb-2 text-muted">
                                <i class="fa-solid fa-users me-1"></i>@p.SoNguoiO khách
                            </div>
                            <div class="small p-2 bg-light rounded text-center" style="font-size:0.8rem;">
                                @(p.NgayCheckIn?.ToString("dd/MM") ?? "?")
                                <i class="fa-solid fa-arrow-right mx-1 text-muted"></i>
                                @(p.NgayCheckOut?.ToString("dd/MM") ?? "?")
                            </div>

                            if (p.CoDungDichVu == "Có")
                            {
                                <div class="mt-2 text-center">
                                    <span class="badge bg-info text-dark border-0"><i class="fa-solid fa-bell-concierge me-1"></i>Dịch vụ</span>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-center py-4 text-muted opacity-25">
                                <i class="fa-solid fa-bed fs-1"></i>
                                <div class="small mt-1">Trống</div>
                            </div>
                        }
                    </div>

                    <div class="card-footer bg-white border-top-0 p-2">
                        @if (p.TrangThaiPhong == "Chờ dọn")
                        {
                            // Form gọi Action CleanRoom
                            <form action="@Url.Action("CleanRoom")" method="post">
                                <input type="hidden" name="maPhong" value="@p.MaPhong" />
                                <button class="btn btn-warning w-100 btn-sm fw-bold text-dark">
                                    <i class="fa-solid fa-check me-1"></i> Đã dọn xong
                                </button>
                            </form>
                        }
                        else if (p.TrangThaiPhong == "Sẵn sàng")
                        {
                            <a href="@Url.Action("CheckIn", "Admin")" class="btn btn-outline-primary w-100 btn-sm fw-bold">
                                <i class="fa-solid fa-key me-1"></i> Check-in
                            </a>
                        }
                        else if (p.CoKhach == "Có")
                        {
                            <div class="d-flex gap-1">
                                <a href="@Url.Action("CheckOut", "Admin", new { maDatPhong = /*Bạn cần lấy MaDatPhong từ SP*/ 0 })"
                                   class="btn btn-primary w-50 btn-sm" title="Trả phòng & Thanh toán">
                                    <i class="fa-solid fa-file-invoice-dollar"></i> Trả
                                </a>

                                <button type="button" class="btn btn-secondary w-50 btn-sm"
                                        data-bs-toggle="modal" data-bs-target="#modalChuyenPhong"
                                        onclick="setChuyenPhong('@p.MaPhong', /*Cần thêm MaDatPhong vào VM*/)">
                                    <i class="fa-solid fa-right-from-bracket"></i> Chuyển
                                </button>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>